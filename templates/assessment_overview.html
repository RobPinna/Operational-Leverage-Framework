{% extends "base.html" %}

{% block content %}
{% set metrics = overview.overview_metrics if overview.overview_metrics is defined else {} %}
{% set ordered = overview.ordered_risks if overview.ordered_risks is defined else [] %}
{% set mitre_codes = overview.mitre_codes if overview.mitre_codes is defined else [] %}
{% set top = overview.topRiskVerdict %}
{% set delta = metrics.delta_vs_previous if metrics and metrics.delta_vs_previous is defined else None %}

<div class="page-shell max-w-6xl">
  <section class="section-stack">
    <div>
      <h2 class="section-title">Assessment snapshot</h2>
      <p class="section-subtitle">Concise risk posture summary for this assessment run.</p>
    </div>
    <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="info-card compact">
        <p class="kpi-label">Detected risks</p>
        <p class="kpi-value">{{ metrics.detected_risks if metrics else 0 }}</p>
        <p class="item-description mt-2">
          Elevated {{ overview.status_counts.get('ELEVATED', 0) }} | Watchlist {{ overview.status_counts.get('WATCHLIST', 0) }} | Baseline {{ overview.status_counts.get('BASELINE', 0) }}
        </p>
      </div>
      <div class="info-card compact">
        <p class="kpi-label">Overall score</p>
        <p class="kpi-value">{{ metrics.overall_score if metrics else 0 }}</p>
        <p class="item-description mt-2">Scale 0-100. Higher value means higher aggregate exposure.</p>
      </div>
      <div class="info-card compact">
        <p class="kpi-label">Delta vs previous</p>
        {% if delta is not none %}
        {% set delta_sign = '+' if delta > 0 else '' %}
        {% if delta > 0 %}
        {% set delta_class = 'delta-positive' %}
        {% elif delta < 0 %}
        {% set delta_class = 'delta-negative' %}
        {% else %}
        {% set delta_class = 'delta-neutral' %}
        {% endif %}
        <p class="kpi-value {{ delta_class }}">{{ delta_sign }}{{ delta }}</p>
        <p class="item-description mt-2">
          Previous: {{ metrics.previous_score }}
          {% if metrics.previous_assessment_id %}
          (assessment #{{ metrics.previous_assessment_id }})
          {% endif %}
        </p>
        {% else %}
        <p class="kpi-value">N/A</p>
        <p class="item-description mt-2">No previous comparable assessment found.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="section-stack">
    <article class="panel p-6">
      <div class="section-header-row">
        <div>
          <h2 class="section-title">Ordered risks</h2>
          <p class="section-subtitle">Sorted by current risk relevance. Top risk is highlighted.</p>
        </div>
        <a class="btn-ghost text-xs" href="/assessments/{{ assessment.id }}/risks">Open full risks page</a>
      </div>
      <div class="divider"></div>

      {% if ordered %}
      {% set top_item = ordered[0] %}
      <article class="info-card p-5 border border-violet-400/35">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <div>
            <p class="badge">Top risk</p>
            <h3 class="text-lg font-semibold text-white mt-2">#{{ top_item.rank }} {{ top_item.title }}</h3>
          </div>
          <a class="btn-primary text-xs" href="{{ top_item.scenario_url }}">Open risk</a>
        </div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <span class="badge">Status: {{ top_item.status }}</span>
          <span class="badge">Likelihood: {{ top_item.likelihood | upper }}</span>
          <span class="badge">Impact: {{ top_item.impact_band }}</span>
          <span class="badge">Evidence: {{ top_item.evidence_strength }} ({{ top_item.confidence }}%)</span>
          <span class="badge">Score: {{ top_item.posture_score }}</span>
        </div>

        {% if top and top.top_risk_id == top_item.id %}
        {% set reasoning = top.reasoning %}
        {% set reasoning_compact = true %}
        {% include "partials/risk_reasoning_block.html" %}
        {% endif %}
      </article>

      {% if (ordered | length) > 1 %}
      <div class="mt-4 space-y-3">
        {% for r in ordered[1:] %}
        <article class="info-card compact">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div class="min-w-0">
              <p class="item-title">#{{ r.rank }} {{ r.title }}</p>
              <p class="item-description mt-1 clamp-2">{{ r.summary if r.summary else "No concise summary available." }}</p>
              <div class="mt-2 flex gap-2 flex-wrap">
                <span class="badge">{{ r.status }}</span>
                <span class="badge">{{ r.likelihood | upper }}</span>
                <span class="badge">{{ r.impact_band }}</span>
                <span class="badge">{{ r.evidence_strength }} {{ r.confidence }}%</span>
                <span class="badge">Score {{ r.posture_score }}</span>
              </div>
            </div>
            <a class="btn-ghost text-xs" href="{{ r.scenario_url }}">Open</a>
          </div>
        </article>
        {% endfor %}
      </div>
      {% endif %}
      {% else %}
      <div class="empty-state">No risks detected yet for this assessment.</div>
      {% endif %}
    </article>
  </section>

  <section class="section-stack">
    <article class="panel p-6">
      <div class="section-header-row">
        <div>
          <h2 class="section-title">MITRE ATT&CK coverage</h2>
          <p class="section-subtitle">Aggregated ATT&CK techniques inferred from current risk set.</p>
        </div>
      </div>
      <div class="divider"></div>
      {% if mitre_codes %}
      <div class="flex flex-wrap gap-3">
        {% for code in mitre_codes %}
        <div class="recipe-block">
          <i data-lucide="crosshair" class="inline-icon"></i>
          <span>{{ code }}</span>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">No MITRE ATT&CK codes mapped yet.</div>
      {% endif %}
    </article>
  </section>

  <section class="section-stack">
    <article class="panel p-6">
      <div class="section-header-row">
        <div>
          <h2 class="section-title">CTI report export</h2>
          <p class="section-subtitle">Download the consolidated PDF report for stakeholders.</p>
        </div>
      </div>
      <div class="divider"></div>
      <div class="flex gap-2 flex-wrap">
        <form method="post" action="/assessments/{{ assessment.id }}/export-pdf">
          <button class="btn-primary text-xs" type="submit">Download CTI PDF report</button>
        </form>
        <a class="btn-ghost text-xs" href="/assessments/{{ assessment.id }}/report">Open report history</a>
      </div>
    </article>
  </section>
</div>
{% endblock %}
