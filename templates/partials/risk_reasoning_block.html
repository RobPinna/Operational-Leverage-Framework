{% if reasoning %}
{% set _compact = reasoning_compact if reasoning_compact is defined else false %}
{% set _wws_raw = (reasoning.what_we_saw or '') | trim %}
{% set _wws_summary = _wws_raw %}
{% set _wws_signals_raw = '' %}
{% if 'Sample signals:' in _wws_raw %}
  {% set _wws_parts = _wws_raw.split('Sample signals:', 1) %}
  {% set _wws_summary = _wws_parts[0] | trim %}
  {% set _wws_signals_raw = _wws_parts[1] | trim %}
{% endif %}
{% set _wws_signals = _wws_signals_raw | replace(' | ', '|') | replace('; ', '|') %}
{% set _wws_evidence_count = '?' %}
{% if ' linked evidence items' in _wws_summary %}
  {% set _wws_evidence_count = (_wws_summary.split(' linked evidence items', 1)[0].split()[-1]) %}
{% endif %}
{% set _wws_correlated_count = '?' %}
{% if 'across ' in _wws_summary and ' signal types' in _wws_summary %}
  {% set _wws_across_tail = _wws_summary.split('across ', 1)[1] %}
  {% set _wws_correlated_count = _wws_across_tail.split(' signal types', 1)[0] | trim %}
{% endif %}
{% set _wws_signal_types_text = '' %}
{% if ' from ' in _wws_summary %}
  {% set _wws_signal_types_text = _wws_summary.split(' from ', 1)[1] | trim %}
{% endif %}
{% if '. Key conditions:' in _wws_signal_types_text %}
  {% set _wws_signal_types_text = _wws_signal_types_text.split('. Key conditions:', 1)[0] | trim %}
{% elif ' Key conditions:' in _wws_signal_types_text %}
  {% set _wws_signal_types_text = _wws_signal_types_text.split(' Key conditions:', 1)[0] | trim %}
{% endif %}
{% set _wws_key_conditions = '' %}
{% if 'Key conditions:' in _wws_summary %}
  {% set _wws_key_conditions = _wws_summary.split('Key conditions:', 1)[1] | trim %}
{% endif %}
{% set _why_matters = (reasoning.why_it_matters or '') | replace('Impact is a conservative estimate based on exposed channels and workflow sensitivity cues.', '') | replace('Impact is a conservative estimate of business impact if the risk materializes.', '') | trim %}
{% set _why_ns = namespace(text=_why_matters) %}
{% for _tail in ['Context:', 'Context :', 'Context -', 'Context'] %}
  {% if _why_ns.text.endswith(_tail) %}
    {% set _why_ns.text = (_why_ns.text[:-(_tail | length)] | trim) %}
  {% endif %}
{% endfor %}
{% set _how_text = (reasoning.how or '') | trim %}
{% set _signal_links = reasoning.signal_links if reasoning.signal_links is defined and reasoning.signal_links else [] %}
{% set _full_text = reasoning_full_text if reasoning_full_text is defined else false %}
<div class="mt-3 grid grid-cols-1 {% if not _compact %}sm:grid-cols-2{% endif %} gap-2">
  <article class="info-card compact">
    <p class="kpi-label">What we saw</p>
    <div class="wws-struct mt-2 {% if _compact %}compact{% endif %}" role="note" aria-label="What we saw in structured editor style">
      <div class="wws-line"><span class="wws-label">linked evidence items</span> <span class="wws-brace">{</span></div>
      <div class="wws-line"><span class="wws-indent-1"></span><span class="wws-count">{{ _wws_evidence_count }}</span> <span class="wws-note">risk-linked</span></div>
      <div class="wws-line"><span class="wws-indent-1"></span><span class="wws-count">{{ _wws_correlated_count }}</span> <span class="wws-note">correlated indicators</span></div>
      <div class="wws-line"><span class="wws-brace">}</span></div>
      <div class="wws-line">&nbsp;</div>
      <div class="wws-line"><span class="wws-label">signal types</span> <span class="wws-brace">{</span></div>
      <div class="wws-line">
        <span class="wws-indent-1"></span><span class="wws-types">{{ _wws_signal_types_text if _wws_signal_types_text else _wws_summary }}</span>
      </div>
      {% if _wws_key_conditions %}
      <div class="wws-line"><span class="wws-indent-1"></span><span class="wws-note">Key conditions:</span></div>
      <div class="wws-line"><span class="wws-indent-2"></span><span class="wws-conditions">{{ _wws_key_conditions }}</span></div>
      {% endif %}
      <div class="wws-line"><span class="wws-brace">}</span></div>
      <div class="wws-line">&nbsp;</div>
      <div class="wws-line"><span class="wws-label">signals</span><span class="wws-op">:</span> <span class="wws-brace">[</span></div>
      {% set _wws_ns = namespace(has_signal=false) %}
      {% for _sig in _wws_signals.split('|') %}
        {% set _sig_text = _sig | trim %}
        {% if _sig_text %}
          {% set _wws_ns.has_signal = true %}
          {% set _sig_code = _sig_text.split(' ', 1)[0] if _sig_text[:2] == 'E-' else '' %}
          {% set _sig_link = namespace(url='') %}
          {% if _sig_code and _signal_links %}
            {% for _sl in _signal_links %}
              {% if _sl.code == _sig_code and _sl.doc_url %}
                {% set _sig_link.url = _sl.doc_url %}
              {% endif %}
            {% endfor %}
          {% endif %}
          <div class="wws-line wws-signal-row">
            <span class="wws-indent-1"></span>
            {% if _sig_text[:2] == 'E-' %}
            <span class="wws-signal-text">{{ _sig_text }}</span>
            {% else %}
            <span class="wws-signal-text">"{{ _sig_text | replace('"', '\\"') }}"</span>
            {% endif %}
            {% if _sig_link.url %}
            <a class="wws-signal-link" href="{{ _sig_link.url }}" title="Open evidence document detail" aria-label="Open evidence document detail">&#8599;</a>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
      {% if not _wws_ns.has_signal %}
      <div class="wws-line"><span class="wws-indent-1"></span><span class="wws-note">// no sample signals captured</span></div>
      {% endif %}
      <div class="wws-line"><span class="wws-brace">]</span></div>
    </div>
  </article>
  <article class="info-card compact">
    <p class="kpi-label">Why it matters</p>
    <p class="item-description mt-1 {% if _compact %}text-xs{% else %}text-sm{% endif %} text-slate-300 whitespace-normal break-words {% if _full_text %}line-clamp-none max-h-none overflow-visible{% endif %}">{{ _why_ns.text }}</p>
    {% if _how_text %}
    <div class="mt-3">
      <p class="kpi-label">How</p>
      <p class="item-description mt-1 {% if _compact %}text-xs{% else %}text-sm{% endif %} text-slate-300 whitespace-normal break-words {% if _full_text %}line-clamp-none max-h-none overflow-visible{% endif %}" data-how-code-highlight="1">{{ _how_text }}</p>
    </div>
    {% endif %}
  </article>
</div>
<script>
  (function () {
    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function styleHowEvidenceCodes(root) {
      var scope = root || document;
      var nodes = scope.querySelectorAll('[data-how-code-highlight="1"]:not([data-how-processed="1"])');
      for (var i = 0; i < nodes.length; i += 1) {
        var node = nodes[i];
        var raw = node.textContent || "";
        var safe = escapeHtml(raw);
        safe = safe.replace(
          /\[(E-\d{2,3}(?:\s*,\s*E-\d{2,3})*)\]/g,
          '<span class="wws-signal-text">[$1]</span>'
        );
        node.innerHTML = safe;
        node.setAttribute("data-how-processed", "1");
      }
    }

    if (window.__applyHowEvidenceCodeStyling) {
      window.__applyHowEvidenceCodeStyling(document);
      return;
    }
    window.__applyHowEvidenceCodeStyling = styleHowEvidenceCodes;
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", function () {
        styleHowEvidenceCodes(document);
      });
      return;
    }
    styleHowEvidenceCodes(document);
  })();
</script>
{% endif %}
