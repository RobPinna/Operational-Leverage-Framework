{% extends "base.html" %}

{% block page_header_right %}
<div class="flex items-center gap-2">
  <a class="btn-ghost text-xs" href="/assessments/{{ assessment.id }}/risks">All risks</a>
  <form method="post" action="/assessments/{{ assessment.id }}/risks/{{ vm.risk.id }}/export-pdf">
    <button class="btn-primary text-xs" type="submit">Download risk report</button>
  </form>
</div>
{% endblock %}

{% block topbar_left %}{% endblock %}
{% block topbar_right %}{% endblock %}

{% block content %}
<script>
  window.__riskDetailVM = {{ vm | tojson }};
</script>

<script>
  function RiskDetailPage(vm) {
    return {
      vm: vm || {},
      drawer: { open: false, title: '', subtitle: '', items: [] },
      openEvidence: function(setId, title) {
        const sets = (this.vm && this.vm.evidenceSets) ? this.vm.evidenceSets : {};
        const items = (sets && sets[setId]) ? sets[setId] : [];
        this.drawer.open = true;
        this.drawer.title = String(title || 'Evidence');
        this.drawer.subtitle = items.length ? (items.length + ' evidence item(s) (deduped)') : 'No evidence items available.';
        this.drawer.items = items;
      },
      closeEvidence: function() {
        this.drawer.open = false;
        this.drawer.title = '';
        this.drawer.subtitle = '';
        this.drawer.items = [];
      },
    };
  }
</script>

<div class="page-shell max-w-6xl mt-3" x-data="RiskDetailPage(window.__riskDetailVM)" x-cloak>
  {% set r = vm.risk %}
  {% set impact_class = 'high' if r.impact_band == 'HIGH' else ('med' if r.impact_band == 'MED' else 'low') %}
  <div class="space-y-5">
    <section class="panel p-6">
      <div class="mt-3 flex flex-wrap gap-2 items-center">
        <span class="badge badge-primary-risk" data-tooltip="Primary risk type (deterministically assigned from validated signals).">
          Primary risk type: {{ vm.risk.primary_risk_type if vm.risk.primary_risk_type else vm.risk.title }}
        </span>
      </div>
      <p class="mt-3 text-lg sm:text-xl font-semibold text-white max-w-3xl">
        {{ (vm.risk.risk_vector_summary or ('Top risk: ' ~ (vm.risk.primary_risk_type or vm.risk.title) ~ ' enabled by limited public signals.')) | replace('Top risk:', 'Risk:') }}
      </p>
      {% set reasoning = vm.risk.reasoning %}
      {% set reasoning_compact = false %}
      {% set reasoning_full_text = true %}
      {% include "partials/risk_reasoning_block.html" %}
    </section>

    <section class="panel p-6">
      <h3 class="section-title">Risk context</h3>
      <div class="mt-4 flex flex-wrap gap-2 items-center">
        <span class="badge-likelihood metric-label" data-tooltip="Estimated likelihood derived from distinct public signals (defensive-only).">
          <span class="metric-key">Likelihood:</span>
          <span class="metric-value {{ r.likelihood }}">{{ r.likelihood | upper }}</span>
        </span>
        <span class="badge-severity metric-label">
          <span class="metric-key">Impact:</span>
          <span class="metric-value {{ impact_class }}">{{ r.impact_band }}</span>
        </span>
        <span class="badge-confidence metric-label" data-tooltip="{{ r.evidence_strength_tooltip }}">
          <span class="metric-key">Evidence strength:</span>
          <span class="metric-value {{ 'high' if r.evidence_strength in ['STRONG'] else ('med' if r.evidence_strength in ['OK'] else 'low') }}">{{ r.evidence_strength }}</span>
        </span>
        <span class="badge" data-tooltip="Signal coverage: number and diversity of distinct signals supporting this risk.">
          Signal coverage: {{ r.signal_coverage }}
        </span>
        {% for chip in r.campaign_chips %}
        <span class="badge" data-tooltip="Campaign pattern (heuristic).">{{ chip }}</span>
        {% endfor %}
      </div>
    </section>

    <section class="panel p-6">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h3 class="section-title">Risk recipe</h3>
          <p class="section-subtitle">Signals that combine into a decision-ready risk outcome.</p>
        </div>
      </div>
      <div class="mt-5 flex flex-wrap items-center gap-3">
        {% for b in vm.recipe_bundles %}
        <button type="button" class="recipe-block" @click="openEvidence({{ ('bundle:' ~ b.id) | tojson }}, {{ b.title | tojson }})">
          <span class="recipe-icon"><i data-lucide="{{ b.icon }}"></i></span>
          <span class="recipe-text">
            <span class="recipe-title">{{ b.title }}</span>
            <span class="recipe-meta">{{ b.item_count }} items</span>
          </span>
        </button>
        {% if not loop.last %}
        <span class="recipe-plus">+</span>
        {% endif %}
        {% endfor %}
        <span class="recipe-arrow">-&gt;</span>
        <div class="recipe-outcome">
          <span class="recipe-title">{{ vm.risk.primary_risk_type if vm.risk.primary_risk_type else vm.risk.title }}</span>
        </div>
      </div>
    </section>

    <section class="panel p-6">
      <div class="section-header-row">
        <div>
          <h3 class="section-title">Risk story map</h3>
          <p class="section-subtitle">Per-risk chain from signals to impact.</p>
        </div>
      </div>
      <div class="divider"></div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <p class="story-col-title">Signals</p>
          <div class="space-y-3">
            {% for c in vm.story_map.signals %}
            {% set __sig_set = vm.evidenceSets.get(c.evidence_set_id, []) if vm.evidenceSets else [] %}
            {% set __sig_ev = __sig_set[0] if __sig_set and (__sig_set | length) > 0 else None %}
            {% set __sig_url = __sig_ev.url if __sig_ev else '' %}
            {% set __sig_doc_id = __sig_ev.doc_id if __sig_ev else None %}
            <article class="info-card compact">
              <p class="item-title flex items-center gap-2">
                <i data-lucide="{{ c.icon }}" class="inline-icon"></i>
                {{ c.title }}
              </p>
              <p class="item-description clamp-2 mt-1">{{ c.detail }}</p>
              {% if __sig_set and (__sig_set | length) > 0 %}
              <div class="mt-3 flex gap-2 flex-wrap">
                {% if __sig_url and (__sig_url.startswith('http://') or __sig_url.startswith('https://')) %}
                <a class="badge" href="{{ __sig_url }}" target="_blank" rel="noreferrer">Evidence</a>
                {% elif __sig_doc_id %}
                <a class="badge" href="/documents/{{ __sig_doc_id }}">Evidence</a>
                {% else %}
                <a class="badge" href="/assessments/{{ assessment.id }}/evidence">Evidence</a>
                {% endif %}
              </div>
              {% endif %}
            </article>
            {% else %}
            <div class="empty-state">No signal bundles available.</div>
            {% endfor %}
          </div>
        </div>

        <div>
          <p class="story-col-title">Abuse path</p>
          <div class="abuse-timeline">
            {% for c in vm.story_map.abuse_path %}
            {% set __step_set = vm.evidenceSets.get(c.evidence_set_id, []) if vm.evidenceSets else [] %}
            {% set __step_ev = __step_set[0] if __step_set and (__step_set | length) > 0 else None %}
            {% set __step_url = __step_ev.url if __step_ev else '' %}
            {% set __step_doc_id = __step_ev.doc_id if __step_ev else None %}
            <article class="abuse-step">
              <div class="abuse-step-rail" aria-hidden="true">
                <span class="abuse-step-dot"></span>
                {% if not loop.last %}
                <span class="abuse-step-line"></span>
                {% endif %}
              </div>
              <div class="abuse-step-body">
                <p class="item-title">{{ c.title }}</p>
                <p class="item-description mt-1">{{ c.detail }}</p>
                {% if __step_set and (__step_set | length) > 0 %}
                <div class="mt-2 flex gap-2 flex-wrap">
                {% if __step_url and (__step_url.startswith('http://') or __step_url.startswith('https://')) %}
                <a class="badge" href="{{ __step_url }}" target="_blank" rel="noreferrer">Evidence</a>
                {% elif __step_doc_id %}
                <a class="badge" href="/documents/{{ __step_doc_id }}">Evidence</a>
                {% else %}
                <a class="badge" href="/assessments/{{ assessment.id }}/evidence">Evidence</a>
                {% endif %}
                </div>
                {% endif %}
              </div>
            </article>
            {% else %}
            <div class="empty-state">No timeline steps available.</div>
            {% endfor %}
          </div>
        </div>

        <div>
          <p class="story-col-title">Impact</p>
          <div class="space-y-3">
            {% for c in vm.story_map.impacts %}
            <article class="info-card compact">
              <p class="item-title flex items-center gap-2">
                <i data-lucide="{{ c.icon }}" class="inline-icon"></i>
                {{ c.title }}
              </p>
              <p class="item-description mt-1">{{ c.detail }}</p>
            </article>
            {% else %}
            <div class="empty-state">No impact notes.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <section class="panel p-6">
      <h3 class="section-title">What would confirm</h3>
      <article class="info-card compact mt-4">
        <ul class="space-y-2">
          {% for x in vm.details.confirm_points %}
          <li class="flex gap-2 item-description"><span class="text-emerald-300">-</span><span>{{ x }}</span></li>
          {% else %}
          <li class="item-meta">No confirm criteria available.</li>
          {% endfor %}
        </ul>
      </article>
    </section>

    <section class="panel p-6">
      <h3 class="section-title">Recommended actions</h3>
      <div class="mt-4 space-y-3">
        <article class="info-card compact">
          <p class="kpi-label">What would deny</p>
          <ul class="mt-2 space-y-2">
            {% for x in vm.details.deny_points %}
            <li class="flex gap-2 item-description"><span class="text-sky-300">-</span><span>{{ x }}</span></li>
            {% else %}
            <li class="item-meta">No deny criteria available.</li>
            {% endfor %}
          </ul>
        </article>

        <article class="info-card compact">
          <p class="kpi-label">Control points</p>
          <div class="mt-3 space-y-2">
            {% for cp in vm.details.control_points %}
            <div class="kpi-mini">
              <div class="flex items-start gap-3">
                <div class="inline-flex h-7 w-7 items-center justify-center rounded-lg border border-white/10 bg-white/5 text-slate-200">
                  <i data-lucide="check-circle-2" class="h-4 w-4"></i>
                </div>
                <div class="min-w-0">
                  <p class="item-title">{{ cp.title }}</p>
                  <p class="item-meta mt-1">Effort: {{ cp.effort }} | Expected reduction: {{ cp.expected_reduction }}</p>
                </div>
              </div>
            </div>
            {% else %}
            <div class="empty-state">No control points available yet.</div>
            {% endfor %}
          </div>
        </article>
      </div>
    </section>

    <section class="panel p-6" id="evidence">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div>
          <h3 class="section-title">Top evidence</h3>
          <p class="section-subtitle">Evidence shown here passed relevance validation for this risk type.</p>
        </div>
        <a class="btn-ghost text-xs" href="/assessments/{{ assessment.id }}/evidence">Evidence log</a>
      </div>
      <div class="mt-4 space-y-3">
        {% for ev in vm.details.evidence %}
        <article class="info-card compact">
          <div class="flex items-start justify-between gap-3 flex-wrap">
            <div class="min-w-0">
              <p class="item-description clamp-2">{{ ev.snippet }}</p>
              <p class="item-meta mt-2">
                <span class="badge">{{ ev.signal_type }}</span>
                <span class="ml-2">Confidence: {{ ev.confidence }}%</span>
              </p>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              {% if ev.doc_id %}
              <a class="btn-ghost text-xs" href="/documents/{{ ev.doc_id }}">Document</a>
              {% endif %}
              {% if ev.url %}
              <a class="btn-ghost text-xs" href="{{ ev.url }}" target="_blank" rel="noreferrer">Source</a>
              {% endif %}
            </div>
          </div>
        </article>
        {% else %}
        <div class="empty-state">Insufficient evidence.</div>
        {% endfor %}
      </div>
    </section>

    <section class="panel p-6">
      <div class="section-header-row">
        <div>
          <h3 class="section-title">MITRE ATT&CK categories</h3>
          <p class="section-subtitle">Mapped ATT&CK techniques for this risk.</p>
        </div>
      </div>
      <div class="mt-4">
        {% if r.mitre_chips %}
        <div class="flex flex-wrap gap-3">
          {% for code in r.mitre_chips %}
          <div class="recipe-block">
            <i data-lucide="crosshair" class="inline-icon"></i>
            <span>{{ code }}</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">No MITRE ATT&CK categories mapped.</div>
        {% endif %}
      </div>
    </section>
  </div>

  <div class="modal-overlay" x-show="drawer.open" x-transition.opacity @click.self="closeEvidence()">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h3 class="modal-title" x-text="drawer.title"></h3>
          <p class="modal-subtitle" x-text="drawer.subtitle"></p>
        </div>
        <button class="btn-ghost text-xs" @click="closeEvidence()">Close</button>
      </div>
      <div class="modal-body">
        <div class="space-y-3">
          <template x-for="it in drawer.items" :key="it.canonical_url + '|' + it.signal_type + '|' + (it.snippet || '')">
            <div class="rounded-xl border border-slate-200/10 bg-white/5 p-4">
              <div class="flex items-start justify-between gap-3 flex-wrap">
                <div class="min-w-0">
                  <p class="text-sm text-white clamp-2" x-text="it.snippet"></p>
                  <div class="mt-2 flex gap-2 flex-wrap items-center text-xs text-slate-300">
                    <span class="badge" x-text="it.signal_type || 'OTHER'"></span>
                    <span x-text="(it.confidence || 0) + '%'"></span>
                    <span class="text-slate-500" x-text="it.domain || ''"></span>
                  </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                  <a class="btn-ghost text-xs" :href="'/documents/' + it.doc_id" x-show="it.doc_id">Document</a>
                  <a class="btn-ghost text-xs" :href="it.url" target="_blank" rel="noreferrer" x-show="it.url">Source</a>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
