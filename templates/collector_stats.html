{% extends "base.html" %}

{% block content %}
<div class="page-shell">
  {% include "partials/assessment_breadcrumb.html" %}

  <section class="section-stack grid gap-3 sm:grid-cols-2 xl:grid-cols-4">
    <article class="kpi-card p-4"><p class="kpi-label">Log Rows</p><p class="kpi-value">{{ kpis.total_log_rows }}</p></article>
    <article class="kpi-card p-4"><p class="kpi-label">Fetched Rows</p><p class="kpi-value">{{ kpis.fetched_count }}</p></article>
    <article class="kpi-card p-4"><p class="kpi-label">Parsed Rows</p><p class="kpi-value">{{ kpis.parsed_count }}</p></article>
    <article class="kpi-card p-4"><p class="kpi-label">Failed Rows</p><p class="kpi-value">{{ kpis.failed_count }}</p></article>
    <article class="kpi-card p-4"><p class="kpi-label">Median Text Chars</p><p class="kpi-value">{{ kpis.median_text_chars }}</p></article>
  </section>

  <section class="section-stack grid gap-3 sm:grid-cols-3">
    <article class="panel p-4">
      <h2 class="section-title">PDF Extraction</h2>
      <p class="item-description mt-2">PDF rows: {{ kpis.pdf_total }}</p>
      <p class="item-description">PDF parsed: {{ kpis.pdf_parsed }}</p>
      <p class="item-description">OCR candidates: {{ kpis.pdf_ocr_candidates }}</p>
    </article>
    <article class="panel p-4">
      <h2 class="section-title">Documents</h2>
      <p class="item-description mt-2">Documents total: {{ kpis.documents_total }}</p>
      <p class="item-description">Median extracted chars: {{ doc_text_median }}</p>
    </article>
    <article class="panel p-4">
      <h2 class="section-title">Tools</h2>
      <a class="btn-ghost mt-2 inline-block" href="/assessments/{{ assessment.id }}/rag-debug">Open RAG Debug</a>
      <a class="btn-ghost mt-2 inline-block" href="/assessments/{{ assessment.id }}/evidence">Open Evidence Log</a>
    </article>
  </section>

  <section class="section-stack grid gap-3 xl:grid-cols-2">
    <article class="panel p-4">
      <h2 class="section-title">Status Distribution</h2>
      <div class="mt-3 space-y-2">
        {% for key, val in status_counts.items() %}
        <div class="flex items-center justify-between border-b border-slate-200 py-2">
          <span class="item-meta">{{ key }}</span>
          <span class="badge">{{ val }}</span>
        </div>
        {% else %}
        <div class="empty-state">No status data.</div>
        {% endfor %}
      </div>
    </article>
    <article class="panel p-4">
      <h2 class="section-title">Source Type Distribution</h2>
      <div class="mt-3 space-y-2">
        {% for key, val in source_counts.items() %}
        <div class="flex items-center justify-between border-b border-slate-200 py-2">
          <span class="item-meta">{{ key }}</span>
          <span class="badge">{{ val }}</span>
        </div>
        {% else %}
        <div class="empty-state">No source data.</div>
        {% endfor %}
      </div>
    </article>
  </section>

  <section class="section-stack panel p-4">
    <h2 class="section-title">Recent Collector Rows</h2>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="border-b border-slate-200 text-slate-600">
          <tr>
            <th class="text-left p-2">URL</th>
            <th class="text-left p-2">Status</th>
            <th class="text-left p-2">Chars</th>
            <th class="text-left p-2">Rendered</th>
            <th class="text-left p-2">PDF Pages</th>
            <th class="text-left p-2">Fetched At</th>
          </tr>
        </thead>
        <tbody>
          {% for row in recent_rows %}
          <tr class="border-b border-slate-100">
            <td class="p-2 max-w-[560px]"><span class="item-meta break-all">{{ row.url }}</span></td>
            <td class="p-2"><span class="badge">{{ row.status }}</span></td>
            <td class="p-2">{{ row.extracted_chars if row.extracted_chars is not none else '-' }}</td>
            <td class="p-2">{{ 'yes' if row.was_rendered else 'no' if row.was_rendered is not none else '-' }}</td>
            <td class="p-2">{{ row.pdf_pages if row.pdf_pages is not none else '-' }}</td>
            <td class="p-2">{{ row.fetched_at.strftime('%Y-%m-%d %H:%M:%S') if row.fetched_at else '-' }}</td>
          </tr>
          {% else %}
          <tr><td class="p-4 text-slate-500" colspan="6">No collector rows.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}
